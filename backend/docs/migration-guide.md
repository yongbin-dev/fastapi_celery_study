# SQLAlchemy 마이그레이션 가이드 (초보자용)

이 가이드는 SQLAlchemy와 Alembic을 사용한 데이터베이스 마이그레이션을 처음 접하는 분들을 위한 상세한 설명서입니다.

## 📖 목차
1. [마이그레이션이란?](#마이그레이션이란)
2. [환경 설정](#환경-설정)
3. [기본 명령어](#기본-명령어)
4. [실제 예시와 워크플로우](#실제-예시와-워크플로우)
5. [문제 해결](#문제-해결)
6. [주의사항](#주의사항)

## 마이그레이션이란?

**마이그레이션**은 데이터베이스의 구조(스키마)를 버전 관리하는 방법입니다.

### 왜 필요한가요?
- 데이터베이스 구조 변경을 추적할 수 있습니다
- 팀원들과 같은 데이터베이스 상태를 유지할 수 있습니다
- 배포 시 데이터베이스를 안전하게 업데이트할 수 있습니다
- 문제 발생 시 이전 상태로 되돌릴 수 있습니다

### 예시 상황
```python
# 처음에 User 모델이 이렇게 있었다면
class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    username = Column(String(50))

# 나중에 email 필드를 추가하고 싶을 때
class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    username = Column(String(50))
    email = Column(String(255))  # 새로 추가!
```

마이그레이션을 사용하면 이런 변경사항을 안전하게 데이터베이스에 반영할 수 있습니다.

## 환경 설정

### 1. 필요한 패키지 설치
```bash
# 비동기 PostgreSQL 드라이버 (FastAPI용)
poetry add asyncpg

# 동기 PostgreSQL 드라이버 (Alembic용)
poetry add psycopg2-binary

# Alembic (마이그레이션 도구)
poetry add alembic
```

### 2. Alembic 초기화 (이미 완료됨)
```bash
alembic init migrations
```

### 3. 설정 파일 확인

#### `alembic.ini` 파일
```ini
# 중요: 동기 드라이버 사용 (asyncpg 아님!)
sqlalchemy.url = postgresql+psycopg2://사용자명:비밀번호@호스트:포트/데이터베이스명
```

#### `migrations/env.py` 파일
```python
# 모델들을 import해야 Alembic이 인식할 수 있습니다
from app.models.base import Base
from app.models import user  # 모든 모델 파일을 import

# 이 부분이 중요!
target_metadata = Base.metadata  # None이 아니어야 함!
```

## 기본 명령어

### 📊 상태 확인 명령어
```bash
# 현재 마이그레이션 상태 확인
alembic current

# 마이그레이션 히스토리 확인
alembic history

# 상세 히스토리 확인
alembic history --verbose
```

### 🔄 마이그레이션 생성
```bash
# 자동으로 모델 변경사항을 감지하여 마이그레이션 생성
alembic revision --autogenerate -m "설명 메시지"

# 수동으로 빈 마이그레이션 파일 생성
alembic revision -m "설명 메시지"
```

### ⬆️ 마이그레이션 적용 (업그레이드)
```bash
# 최신 마이그레이션까지 적용
alembic upgrade head

# 특정 리비전까지 적용
alembic upgrade abc123

# 한 단계씩 적용
alembic upgrade +1
```

### ⬇️ 마이그레이션 되돌리기 (다운그레이드)
```bash
# 한 단계 되돌리기
alembic downgrade -1

# 특정 리비전으로 되돌리기
alembic downgrade abc123

# 모든 마이그레이션 되돌리기 (주의!)
alembic downgrade base
```

### 🏷️ 기타 유용한 명령어
```bash
# 기존 데이터베이스를 현재 모델과 동기화된 것으로 표시 (초기 설정용)
alembic stamp head

# 특정 리비전 정보 확인
alembic show abc123
```

## 실제 예시와 워크플로우

### 시나리오: User 모델에 새 필드 추가하기

#### 1단계: 모델 수정
```python
# app/models/user.py
class User(Base):
    __tablename__ = "users"
    
    # 기존 필드들
    email = Column(String(255), unique=True, index=True, nullable=False)
    username = Column(String(100), unique=True, index=True, nullable=False)
    full_name = Column(String(255), nullable=True)
    hashed_password = Column(String(255), nullable=False)
    is_active = Column(Boolean, default=True, nullable=False)
    is_superuser = Column(Boolean, default=False, nullable=False)
    bio = Column(Text, nullable=True)
    
    # 새로 추가하는 필드
    phone = Column(String(20), nullable=True)  # 전화번호 필드 추가
    birth_date = Column(DateTime, nullable=True)  # 생년월일 필드 추가
```

#### 2단계: 마이그레이션 생성
```bash
alembic revision --autogenerate -m "Add phone and birth_date to users"
```

실행 결과:
```
Generating /path/to/migrations/versions/def456_add_phone_and_birth_date_to_users.py ...  done
INFO  [alembic.autogenerate.compare] Detected added column 'users.phone'
INFO  [alembic.autogenerate.compare] Detected added column 'users.birth_date'
```

#### 3단계: 생성된 마이그레이션 파일 검토
```python
# migrations/versions/def456_add_phone_and_birth_date_to_users.py
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('phone', sa.String(length=20), nullable=True))
    op.add_column('users', sa.Column('birth_date', sa.DateTime(), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'birth_date')
    op.drop_column('users', 'phone')
    # ### end Alembic commands ###
```

#### 4단계: 마이그레이션 적용
```bash
alembic upgrade head
```

실행 결과:
```
INFO  [alembic.runtime.migration] Running upgrade abc123 -> def456, Add phone and birth_date to users
```

#### 5단계: 결과 확인
```bash
alembic current
```

실행 결과:
```
def456 (head)
```

### 다른 예시들

#### 인덱스 추가
```python
# 모델에서
class User(Base):
    email = Column(String(255), unique=True, index=True)  # index=True 추가
```

```bash
alembic revision --autogenerate -m "Add index to user email"
alembic upgrade head
```

#### 테이블 이름 변경
```python
# 모델에서
class User(Base):
    __tablename__ = "app_users"  # "users"에서 변경
```

#### 제약 조건 추가
```python
from sqlalchemy import CheckConstraint

class User(Base):
    age = Column(Integer, CheckConstraint('age >= 0'), nullable=True)
```

## 문제 해결

### 자주 발생하는 오류들

#### 1. `MissingGreenlet` 오류
```
sqlalchemy.exc.MissingGreenlet: greenlet_spawn has not been called
```

**원인:** `alembic.ini`에서 비동기 드라이버(`postgresql+asyncpg`)를 사용하고 있음

**해결:** 동기 드라이버로 변경
```ini
# 잘못된 설정
sqlalchemy.url = postgresql+asyncpg://user:pass@localhost/db

# 올바른 설정
sqlalchemy.url = postgresql+psycopg2://user:pass@localhost/db
```

#### 2. 모델이 감지되지 않는 오류
```
INFO  [alembic.autogenerate.compare] Detected no changes
```

**원인:** `migrations/env.py`에서 모델을 제대로 import하지 않음

**해결:** 모든 모델 파일을 import
```python
# migrations/env.py
from app.models.base import Base
from app.models import user  # 모든 모델 파일
from app.models import product  # 추가 모델이 있다면

target_metadata = Base.metadata  # None이 아니어야 함!
```

#### 3. 데이터베이스 연결 오류
```
sqlalchemy.exc.OperationalError: connection failed
```

**해결 방법:**
1. 데이터베이스가 실행 중인지 확인
2. 연결 정보가 올바른지 확인
3. 방화벽/네트워크 설정 확인

```bash
# Docker로 PostgreSQL 실행하는 경우
docker-compose up -d  # 데이터베이스 서비스 시작
```

#### 4. 마이그레이션 충돌
```
FAILED: Multiple head revisions are present
```

**해결:** 브랜치를 병합하거나 리베이스
```bash
alembic merge heads -m "Merge conflicting migrations"
```

### 디버깅 팁

#### 1. 상세 로그 확인
```bash
# 더 자세한 정보 출력
alembic -x verbose=true upgrade head
```

#### 2. SQL 명령어 확인 (실행하지 않고)
```bash
# 오프라인 모드로 SQL 확인
alembic upgrade head --sql
```

#### 3. 특정 리비전 정보 확인
```bash
alembic show abc123
```

## 주의사항

### ⚠️ 중요한 주의사항

#### 1. 프로덕션 환경에서는 신중하게!
```bash
# 프로덕션에서는 반드시 백업 후 실행
# 1. 데이터베이스 백업
pg_dump mydb > backup.sql

# 2. 마이그레이션 테스트
alembic upgrade head --sql  # SQL 먼저 확인

# 3. 실제 적용
alembic upgrade head
```

#### 2. 데이터 손실 위험이 있는 작업들
```python
# 위험한 작업들 - 주의!
- Column 삭제: op.drop_column('users', 'old_field')
- 테이블 삭제: op.drop_table('old_table')
- 데이터 타입 변경: sa.Column('age', sa.String())  # Integer → String
```

#### 3. 마이그레이션 파일은 절대 수동 삭제 금지!
- Git에서 관리되어야 함
- 팀원들과 동기화 필요
- 순서가 중요함

#### 4. 큰 테이블 마이그레이션 시 주의사항
```python
# 큰 테이블에 NOT NULL 컬럼 추가 시
# 1단계: NULL 허용으로 추가
op.add_column('big_table', sa.Column('new_field', sa.String(), nullable=True))

# 2단계: 기본값 업데이트 (별도 스크립트)
# UPDATE big_table SET new_field = 'default_value';

# 3단계: NOT NULL 제약 추가
op.alter_column('big_table', 'new_field', nullable=False)
```

### 💡 베스트 프랙티스

#### 1. 명확한 마이그레이션 메시지 작성
```bash
# 좋은 예시
alembic revision --autogenerate -m "Add user authentication fields"
alembic revision --autogenerate -m "Create orders table with foreign keys"

# 나쁜 예시
alembic revision --autogenerate -m "update"
alembic revision --autogenerate -m "fix"
```

#### 2. 마이그레이션 적용 전 항상 검토
```bash
# 생성된 마이그레이션 파일 확인
cat migrations/versions/latest_migration.py

# SQL 미리 보기
alembic upgrade head --sql
```

#### 3. 환경별 설정 관리
```python
# config.py에서 환경별 DB URL 관리
import os

DATABASE_URL = os.getenv(
    "DATABASE_URL",
    "postgresql+psycopg2://user:pass@localhost/db"
)
```

#### 4. 정기적인 마이그레이션 상태 확인
```bash
# 현재 상태와 최신 상태 비교
- alembic current
- alembic show head

- alembic current로 현재 상태 확인
- alembic check로 모델과 DB 스키마 차이점 발견
- alembic revision --autogenerate로 새 마이그레이션 생성
- alembic upgrade head로 마이그레이션 적용


```

---

## 🔄 기존 데이터베이스에서 모델 자동 생성 (리버스 엔지니어링)

기존에 있는 데이터베이스 테이블을 기반으로 SQLAlchemy 모델을 자동 생성할 수 있습니다.

### sqlacodegen 설치 및 사용

#### 1. 설치
```bash
poetry add "sqlacodegen>=3.0,<3.1"
```

#### 2. 기본 사용법
```bash
# 모든 테이블에서 모델 생성
sqlacodegen postgresql+psycopg2://user:pass@host:port/dbname

# 특정 테이블만 생성
sqlacodegen postgresql+psycopg2://user:pass@host:port/dbname --tables users,orders

# 파일로 저장
sqlacodegen postgresql+psycopg2://user:pass@host:port/dbname > models/generated.py
```

#### 3. 다양한 생성 방식

##### 기본 Declarative 방식
```bash
sqlacodegen postgresql+psycopg2://sa:1@localhost:15432/postgres --outfile app/models/generated_models.py
```

생성 결과:
```python
class Users(Base):
    __tablename__ = 'users'
    
    email: Mapped[str] = mapped_column(String(255))
    username: Mapped[str] = mapped_column(String(100))
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    # ...
```

##### Dataclass 방식
```bash
sqlacodegen postgresql+psycopg2://sa:1@localhost:15432/postgres --generator dataclasses --outfile app/models/dataclass_models.py
```

생성 결과:
```python
class Base(MappedAsDataclass, DeclarativeBase):
    pass

class Users(Base):
    # dataclass 형태로 생성됨
```

##### 테이블 방식 (Core 스타일)
```bash
sqlacodegen postgresql+psycopg2://sa:1@localhost:15432/postgres --generator tables --outfile app/models/table_models.py
```

#### 4. 유용한 옵션들

```bash
# 특정 스키마만
sqlacodegen postgresql+psycopg2://user:pass@host/db --schemas public,custom

# 뷰 제외
sqlacodegen postgresql+psycopg2://user:pass@host/db --noviews

# 여러 테이블 지정
sqlacodegen postgresql+psycopg2://user:pass@host/db --tables users,orders,products
```

#### 5. 실제 프로젝트에서 활용 방법

##### 방법 1: 기존 DB를 현재 상태로 표시
```bash
# 1. 기존 테이블에서 모델 생성
sqlacodegen postgresql+psycopg2://sa:1@localhost:15432/postgres > temp_models.py

# 2. 생성된 모델을 기존 모델에 통합
# (수동으로 복사/붙여넣기 또는 비교)

# 3. 현재 상태를 마이그레이션 기준으로 설정
alembic stamp head

# 4. 이후 변경사항만 마이그레이션으로 관리
alembic revision --autogenerate -m "Add new features"
```

##### 방법 2: 새로운 테이블 추가할 때
```bash
# 1. 새 테이블이 추가된 후
# 2. 해당 테이블만 모델로 생성
sqlacodegen postgresql+psycopg2://sa:1@localhost:15432/postgres --tables new_table

# 3. 생성된 모델을 프로젝트에 통합
```

### 주의사항

#### 1. 생성된 코드 검토 필수
- 자동 생성된 코드는 항상 검토가 필요합니다
- 관계(Relationship) 정보는 수동으로 추가해야 할 수 있습니다
- 비즈니스 로직은 별도로 추가해야 합니다

#### 2. 기존 모델과의 충돌 주의
- 새로 생성된 Base 클래스와 기존 Base 클래스를 통합해야 합니다
- 클래스명이 겹치지 않는지 확인하세요

#### 3. 타입 정확성 확인
```python
# 생성된 코드에서 확인할 점들
- 날짜/시간 타입이 올바른지
- 외래키 관계가 올바른지  
- NULL 가능 여부가 맞는지
- 기본값이 올바르게 설정되었는지
```

### 기존 DB 마이그레이션 워크플로우

```bash
# 1. 기존 DB 구조 확인
sqlacodegen postgresql+psycopg2://sa:1@localhost:15432/postgres

# 2. 필요한 테이블만 모델로 생성
sqlacodegen postgresql+psycopg2://sa:1@localhost:15432/postgres --tables users,orders --outfile models/from_db.py

# 3. 생성된 모델을 프로젝트 구조에 맞게 정리
# - app/models/ 디렉토리에 각 모델별로 분리
# - 관계(relationships) 추가
# - 비즈니스 메서드 추가

# 4. 현재 상태를 마이그레이션 기준점으로 설정
alembic stamp head

# 5. 새로운 변경사항은 정상적인 마이그레이션으로 관리
alembic revision --autogenerate -m "새로운 기능 추가"
```

이렇게 하면 기존 데이터베이스를 기반으로 한 개발을 시작할 수 있습니다!

---

## 📚 추가 학습 자료

- [Alembic 공식 문서](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 공식 문서](https://docs.sqlalchemy.org/)
- [FastAPI 데이터베이스 가이드](https://fastapi.tiangolo.com/tutorial/sql-databases/)
- [sqlacodegen GitHub](https://github.com/agronholm/sqlacodegen)

이 가이드로 SQLAlchemy 마이그레이션을 안전하고 효율적으로 관리하실 수 있을 것입니다! 🚀