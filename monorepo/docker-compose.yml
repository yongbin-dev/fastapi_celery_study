version: '3.8'

services:
  # PostgreSQL 데이터베이스 (로컬 개발용 - Supabase 대신 사용 시)
  # postgres-db:
  #   image: postgres:16-alpine
  #   container_name: postgres-db
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #     POSTGRES_DB: postgres
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - app-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Server
  api_server:
    image: api_server:latest
    container_name: api_server
    platform: linux/amd64  
    build:
      context: .
      dockerfile: packages/api_server/Dockerfile
    env_file:
      - .env.development
    environment:
      REDIS_URL: "redis://redis:6379/0"
      CELERY_BROKER_URL: "redis://redis:6379/1"
      CELERY_RESULT_BACKEND: "redis://redis:6379/2"
      OCR_MODEL_SERVER_URL: "http://ml_server:8001"
    ports:
      - "8000:8000"
    networks:
      - app-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Celery Worker
  celery_worker:
    image: celery_worker:latest
    container_name: celery_worker
    platform: linux/amd64  
    build:
      context: .
      dockerfile: packages/celery_worker/Dockerfile
    env_file:
      - .env.development
    environment:
      # Docker 네트워크 내에서 사용할 주소로 오버라이드
      REDIS_URL: "redis://redis:6379/0"
      CELERY_BROKER_URL: "redis://redis:6379/1"
      CELERY_RESULT_BACKEND: "redis://redis:6379/2"
      OCR_MODEL_SERVER_URL: "http://ml_server:8001"
      ML_SERVER_GRPC_ADDRESS: "ml_server:50051"
    networks:
      - app-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # # ML Server (OCR)
  ml_server:
    image: ml_server:latest
    container_name: ml_server
    platform: linux/amd64  
    build:
      context: .
      dockerfile: packages/ml_server/Dockerfile.gpu
    env_file:
      - .env.development
    environment:
      OCR_ENGINE: "easyocr"
    ports:
      - "8001:8001"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

networks:
  app-network:
    driver: bridge

volumes:
  # postgres_data:
  redis_data:
