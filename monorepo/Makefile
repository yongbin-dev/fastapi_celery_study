
# Makefile for Monorepo

# ==============================================================================
# λ³€μ μ •μ
# ==============================================================================

# Python μΈν„°ν”„λ¦¬ν„°
PYTHON = python3

# ν¨ν‚¤μ§€ λ””λ ‰ν† λ¦¬
API_SERVER_DIR = packages/api_server
CELERY_WORKER_DIR = packages/celery_worker
ML_SERVER_DIR = packages/ml_server

# ==============================================================================
# μμ΅΄μ„± κ΄€λ¦¬
# ==============================================================================

.PHONY: install
install:
	@echo "π“¦ λ¨λ“  ν¨ν‚¤μ§€λ¥Ό μ„¤μΉν•©λ‹λ‹¤..."
	@./scripts/setup_all_packages.sh

# ==============================================================================
# μ½”λ“ ν’μ§
# ==============================================================================

.PHONY: lint
lint:
	@echo "λ¦°νΈλ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤..."
	@uv run ruff check .

.PHONY: format
format:
	@echo "μ½”λ“λ¥Ό ν¬λ§·ν…ν•©λ‹λ‹¤..."
	@uv run ruff format .

.PHONY: typecheck
typecheck:
	@echo "νƒ€μ… μ²΄ν¬λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤..."
	@uv run pyright

# ==============================================================================
# ν…μ¤νΈ
# ==============================================================================

.PHONY: test
test:
	@echo "ν…μ¤νΈλ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤..."
	@uv run pytest

# ==============================================================================
# μ• ν”λ¦¬μΌ€μ΄μ… μ‹¤ν–‰
# ==============================================================================

.PHONY: run-api
run-api:
	@echo "π€ API μ„λ²„λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤..."
	@cd $(API_SERVER_DIR) && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

.PHONY: run-worker
run-worker:
	@echo "Celery μ›μ»¤λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤..."
	@cd $(CELERY_WORKER_DIR) && celery -A celery_app worker --loglevel=info

.PHONY: run-ml
run-ml:
	@echo "π§  ML μ„λ²„λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤..."
	@cd $(ML_SERVER_DIR) && uvicorn ml_app.main:app --host 0.0.0.0 --port 8001 --reload

# ==============================================================================
# μ •λ¦¬
# ==============================================================================

.PHONY: clean
clean:
	@echo "μΊμ‹ νμΌμ„ μ •λ¦¬ν•©λ‹λ‹¤..."
	@find . -type f -name "*.py[co]" -delete
	@find . -type d -name "__pycache__" -delete

# ==============================================================================
# λ„μ›€λ§
# ==============================================================================

.PHONY: help
help:
	@echo "μ‚¬μ© κ°€λ¥ν• λ…λ Ήμ–΄:"
	@echo "  install      - λ¨λ“  ν¨ν‚¤μ§€λ¥Ό μ„¤μΉν•©λ‹λ‹¤."
	@echo "  lint         - λ¦°νΈλ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤."
	@echo "  format       - μ½”λ“λ¥Ό ν¬λ§·ν…ν•©λ‹λ‹¤."
	@echo "  typecheck    - νƒ€μ… μ²΄ν¬λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤."
	@echo "  test         - ν…μ¤νΈλ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤."
	@echo "  run-api      - API μ„λ²„λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤."
	@echo "  run-worker   - Celery μ›μ»¤λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤."
	@echo "  run-ml       - ML μ„λ²„λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤."
	@echo "  clean        - μΊμ‹ νμΌμ„ μ •λ¦¬ν•©λ‹λ‹¤."

