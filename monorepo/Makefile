
# Makefile for Monorepo

# ==============================================================================
# 변수 정의
# ==============================================================================

# Python 인터프리터
PYTHON = python3

# 패키지 디렉토리
API_SERVER_DIR = packages/api_server
CELERY_WORKER_DIR = packages/celery_worker
ML_SERVER_DIR = packages/ml_server

# ==============================================================================
# 의존성 관리
# ==============================================================================

.PHONY: install
install:
	@echo "📦 모든 패키지를 설치합니다..."
	@./scripts/setup_all_packages.sh

# ==============================================================================
# 코드 품질
# ==============================================================================

.PHONY: lint
lint:
	@echo "린트를 실행합니다..."
	@uv run ruff check .

.PHONY: format
format:
	@echo "코드를 포맷팅합니다..."
	@uv run ruff format .

.PHONY: typecheck
typecheck:
	@echo "타입 체크를 실행합니다..."
	@uv run pyright

# ==============================================================================
# 테스트
# ==============================================================================

.PHONY: test
test:
	@echo "테스트를 실행합니다..."
	@uv run pytest

# ==============================================================================
# 애플리케이션 실행
# ==============================================================================

.PHONY: run-api
run-api:
	@echo "🚀 API 서버를 실행합니다..."
	@cd $(API_SERVER_DIR) && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

.PHONY: run-worker
run-worker:
	@echo "Celery 워커를 실행합니다..."
	@cd $(CELERY_WORKER_DIR) && celery -A celery_app worker --loglevel=info

.PHONY: run-ml
run-ml:
	@echo "🧠 ML 서버를 실행합니다..."
	@cd $(ML_SERVER_DIR) && uvicorn ml_app.main:app --host 0.0.0.0 --port 8001 --reload

# ==============================================================================
# 정리
# ==============================================================================

.PHONY: clean
clean:
	@echo "캐시 파일을 정리합니다..."
	@find . -type f -name "*.py[co]" -delete
	@find . -type d -name "__pycache__" -delete

# ==============================================================================
# 도움말
# ==============================================================================

.PHONY: help
help:
	@echo "사용 가능한 명령어:"
	@echo "  install      - 모든 패키지를 설치합니다."
	@echo "  lint         - 린트를 실행합니다."
	@echo "  format       - 코드를 포맷팅합니다."
	@echo "  typecheck    - 타입 체크를 실행합니다."
	@echo "  test         - 테스트를 실행합니다."
	@echo "  run-api      - API 서버를 실행합니다."
	@echo "  run-worker   - Celery 워커를 실행합니다."
	@echo "  run-ml       - ML 서버를 실행합니다."
	@echo "  clean        - 캐시 파일을 정리합니다."

