# FastAPI + Celery + ML ëª¨ë…¸ë ˆí¬ Makefile
# Docker ë¹Œë“œ ë° ê´€ë¦¬ ìë™í™”

.PHONY: help build build-all build-api build-celery build-ml-base build-ml-ocr \
        up down restart logs clean prune dev prod health test

# ê¸°ë³¸ ë³€ìˆ˜
DOCKER_COMPOSE := docker-compose
PROJECT_NAME := fastapi-celery-study
REGISTRY := # Docker registry URL (í•„ìš”ì‹œ ì„¤ì •)

# ì´ë¯¸ì§€ íƒœê·¸
TAG ?= latest
API_IMAGE := $(PROJECT_NAME)-api:$(TAG)
CELERY_IMAGE := $(PROJECT_NAME)-celery:$(TAG)
ML_BASE_IMAGE := backend-ml-base:$(TAG)
ML_BASE_CPU_IMAGE := backend-ml-base-cpu:$(TAG)
ML_OCR_IMAGE := $(PROJECT_NAME)-ml-ocr:$(TAG)

# ë„ì›€ë§
help:
	@echo "======================================"
	@echo "FastAPI + Celery + ML ëª¨ë…¸ë ˆí¬ Make ëª…ë ¹ì–´"
	@echo "======================================"
	@echo ""
	@echo "ë¹Œë“œ ëª…ë ¹ì–´:"
	@echo "  make build-all        - ëª¨ë“  ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  make build-api        - API ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  make build-celery     - Celery Worker ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  make build-ml-base    - ML Base ì´ë¯¸ì§€ ë¹Œë“œ (GPU)"
	@echo "  make build-ml-base-cpu - ML Base ì´ë¯¸ì§€ ë¹Œë“œ (CPU)"
	@echo "  make build-ml-ocr     - ML OCR ì´ë¯¸ì§€ ë¹Œë“œ (ml-base í•„ìš”)"
	@echo ""
	@echo "ì‹¤í–‰ ëª…ë ¹ì–´:"
	@echo "  make up               - ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘"
	@echo "  make down             - ëª¨ë“  ì„œë¹„ìŠ¤ ì¤‘ì§€"
	@echo "  make restart          - ëª¨ë“  ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
	@echo "  make logs             - ë¡œê·¸ í™•ì¸ (tail -f)"
	@echo "  make logs-api         - API ì„œë²„ ë¡œê·¸ë§Œ í™•ì¸"
	@echo "  make logs-celery      - Celery Worker ë¡œê·¸ë§Œ í™•ì¸"
	@echo "  make logs-ml          - ML ì„œë²„ ë¡œê·¸ë§Œ í™•ì¸"
	@echo ""
	@echo "ê´€ë¦¬ ëª…ë ¹ì–´:"
	@echo "  make health           - ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
	@echo "  make clean            - ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ë° ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬"
	@echo "  make prune            - ëª¨ë“  ë¯¸ì‚¬ìš© Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (ì£¼ì˜!)"
	@echo "  make rebuild          - ìºì‹œ ì—†ì´ ì „ì²´ ì¬ë¹Œë“œ"
	@echo ""
	@echo "ê°œë°œ/ë°°í¬:"
	@echo "  make dev              - ê°œë°œ í™˜ê²½ ì‹œì‘ (.env.development)"
	@echo "  make prod             - í”„ë¡œë•ì…˜ í™˜ê²½ ì‹œì‘ (.env)"
	@echo "  make test             - í…ŒìŠ¤íŠ¸ í™˜ê²½ ë¹Œë“œ ë° ì‹¤í–‰"
	@echo ""
	@echo "ì˜µì…˜:"
	@echo "  TAG=v1.0.0 make build-all  - íŠ¹ì • íƒœê·¸ë¡œ ë¹Œë“œ"
	@echo ""

# ì „ì²´ ë¹Œë“œ
build-all: build-ml-base build-api build-celery build-ml-ocr
	@echo "âœ… ëª¨ë“  ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

# API ì„œë²„ ë¹Œë“œ
build-api:
	@echo "ğŸ”¨ API ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	cd packages && docker build \
		-f api_server/Dockerfile \
		-t $(API_IMAGE) \
		--build-arg BUILDKIT_INLINE_CACHE=1 \
		.
	@echo "âœ… API ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $(API_IMAGE)"

# Celery Worker ë¹Œë“œ
build-celery:
	@echo "ğŸ”¨ Celery Worker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	cd packages && docker build \
		-f celery_worker/Dockerfile \
		-t $(CELERY_IMAGE) \
		--build-arg BUILDKIT_INLINE_CACHE=1 \
		.
	@echo "âœ… Celery Worker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $(CELERY_IMAGE)"

# ML Base ì´ë¯¸ì§€ ë¹Œë“œ (GPU ë²„ì „)
build-ml-base:
	@echo "ğŸ”¨ ML Base (GPU) ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	@if [ -f packages/ml_server/Dockerfile.base ]; then \
		cd packages && docker build \
			-f ml_server/Dockerfile.base \
			-t $(ML_BASE_IMAGE) \
			--build-arg BUILDKIT_INLINE_CACHE=1 \
			.; \
	else \
		echo "âš ï¸  Dockerfile.base not found, skipping ml-base build"; \
	fi
	@echo "âœ… ML Base (GPU) ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $(ML_BASE_IMAGE)"

# ML Base CPU ì´ë¯¸ì§€ ë¹Œë“œ (CPU ë²„ì „)
build-ml-base-cpu:
	@echo "ğŸ”¨ ML Base (CPU) ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	@if [ -f packages/ml_server/Dockerfile.base.cpu ]; then \
		cd packages && docker build \
			-f ml_server/Dockerfile.base.cpu \
			-t $(ML_BASE_CPU_IMAGE) \
			--build-arg BUILDKIT_INLINE_CACHE=1 \
			.; \
	else \
		echo "âš ï¸  Dockerfile.base.cpu not found, skipping ml-base-cpu build"; \
	fi
	@echo "âœ… ML Base (CPU) ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $(ML_BASE_CPU_IMAGE)"

# ML OCR ì´ë¯¸ì§€ ë¹Œë“œ (ml-base-cpu ê¸°ë°˜)
build-ml-ocr: build-ml-base-cpu
	@echo "ğŸ”¨ ML OCR (CPU) ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	cd packages && docker build \
		-f ml_server/Dockerfile \
		-t $(ML_OCR_IMAGE) \
		--build-arg BUILDKIT_INLINE_CACHE=1 \
		.
	@echo "âœ… ML OCR (CPU) ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: $(ML_OCR_IMAGE)"

# ìºì‹œ ì—†ì´ ì¬ë¹Œë“œ
rebuild:
	@echo "ğŸ”¨ ìºì‹œ ì—†ì´ ì „ì²´ ì¬ë¹Œë“œ ì¤‘..."
	cd packages && docker build --no-cache -f api_server/Dockerfile -t $(API_IMAGE) .
	cd packages && docker build --no-cache -f celery_worker/Dockerfile -t $(CELERY_IMAGE) .
	@if [ -f packages/ml_server/Dockerfile.base ]; then \
		cd packages && docker build --no-cache -f ml_server/Dockerfile.base -t $(ML_BASE_IMAGE) .; \
	fi
	cd packages && docker build --no-cache -f ml_server/Dockerfile -t $(ML_OCR_IMAGE) .
	@echo "âœ… ì „ì²´ ì¬ë¹Œë“œ ì™„ë£Œ"

# Docker Compose ëª…ë ¹ì–´ (docker-compose.ymlì´ ìˆë‹¤ê³  ê°€ì •)
up:
	@if [ -f docker-compose.yml ]; then \
		echo "ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."; \
		$(DOCKER_COMPOSE) up -d; \
		echo "âœ… ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ"; \
	else \
		echo "âš ï¸  docker-compose.yml not found"; \
	fi

down:
	@if [ -f docker-compose.yml ]; then \
		echo "ğŸ›‘ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."; \
		$(DOCKER_COMPOSE) down; \
		echo "âœ… ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ"; \
	else \
		echo "âš ï¸  docker-compose.yml not found"; \
	fi

restart: down up

# ë¡œê·¸ í™•ì¸
logs:
	@if [ -f docker-compose.yml ]; then \
		$(DOCKER_COMPOSE) logs -f; \
	else \
		echo "âš ï¸  docker-compose.yml not found"; \
	fi

logs-api:
	@if [ -f docker-compose.yml ]; then \
		$(DOCKER_COMPOSE) logs -f api_server; \
	else \
		echo "âš ï¸  docker-compose.yml not found"; \
	fi

logs-celery:
	@if [ -f docker-compose.yml ]; then \
		$(DOCKER_COMPOSE) logs -f celery_worker; \
	else \
		echo "âš ï¸  docker-compose.yml not found"; \
	fi

logs-ml:
	@if [ -f docker-compose.yml ]; then \
		$(DOCKER_COMPOSE) logs -f ml_server; \
	else \
		echo "âš ï¸  docker-compose.yml not found"; \
	fi

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
health:
	@echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
	@if [ -f docker-compose.yml ]; then \
		$(DOCKER_COMPOSE) ps; \
	else \
		docker ps --filter "name=$(PROJECT_NAME)"; \
	fi

# ì •ë¦¬ ëª…ë ¹ì–´
clean:
	@echo "ğŸ§¹ ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ë° ë¯¸ì‚¬ìš© ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
	docker container prune -f
	docker image prune -f
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

prune:
	@echo "âš ï¸  ëª¨ë“  ë¯¸ì‚¬ìš© Docker ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤ (ì»¨í…Œì´ë„ˆ, ë„¤íŠ¸ì›Œí¬, ì´ë¯¸ì§€, ë³¼ë¥¨)"
	@read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? [y/N] " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker system prune -a --volumes -f; \
		echo "âœ… ì •ë¦¬ ì™„ë£Œ"; \
	else \
		echo "âŒ ì·¨ì†Œë¨"; \
	fi

# ê°œë°œ/í”„ë¡œë•ì…˜ í™˜ê²½
dev:
	@if [ -f docker-compose.yml ]; then \
		echo "ğŸš€ ê°œë°œ í™˜ê²½ ì‹œì‘ ì¤‘..."; \
		$(DOCKER_COMPOSE) --env-file .env.development up -d; \
		echo "âœ… ê°œë°œ í™˜ê²½ ì‹œì‘ ì™„ë£Œ"; \
	else \
		echo "âš ï¸  docker-compose.yml not found"; \
	fi

prod:
	@if [ -f docker-compose.yml ]; then \
		echo "ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½ ì‹œì‘ ì¤‘..."; \
		$(DOCKER_COMPOSE) --env-file .env up -d; \
		echo "âœ… í”„ë¡œë•ì…˜ í™˜ê²½ ì‹œì‘ ì™„ë£Œ"; \
	else \
		echo "âš ï¸  docker-compose.yml not found"; \
	fi

# í…ŒìŠ¤íŠ¸ í™˜ê²½
test: build-all
	@echo "ğŸ§ª í…ŒìŠ¤íŠ¸ í™˜ê²½ ì‹¤í–‰ ì¤‘..."
	@if [ -f docker-compose.test.yml ]; then \
		$(DOCKER_COMPOSE) -f docker-compose.test.yml up --abort-on-container-exit; \
		$(DOCKER_COMPOSE) -f docker-compose.test.yml down; \
	else \
		echo "âš ï¸  docker-compose.test.yml not found"; \
	fi

# ì´ë¯¸ì§€ í‘¸ì‹œ (ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì„¤ì • í•„ìš”)
push:
	@if [ -z "$(REGISTRY)" ]; then \
		echo "âš ï¸  REGISTRY ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"; \
		echo "ì˜ˆ: make push REGISTRY=myregistry.com"; \
		exit 1; \
	fi
	@echo "ğŸ“¤ ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
	docker tag $(API_IMAGE) $(REGISTRY)/$(API_IMAGE)
	docker tag $(CELERY_IMAGE) $(REGISTRY)/$(CELERY_IMAGE)
	docker tag $(ML_OCR_IMAGE) $(REGISTRY)/$(ML_OCR_IMAGE)
	docker push $(REGISTRY)/$(API_IMAGE)
	docker push $(REGISTRY)/$(CELERY_IMAGE)
	docker push $(REGISTRY)/$(ML_OCR_IMAGE)
	@echo "âœ… ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"

# ë²„ì „ ì •ë³´ ì¶œë ¥
version:
	@echo "í”„ë¡œì íŠ¸: $(PROJECT_NAME)"
	@echo "íƒœê·¸: $(TAG)"
	@echo ""
	@echo "ì´ë¯¸ì§€:"
	@echo "  - API: $(API_IMAGE)"
	@echo "  - Celery: $(CELERY_IMAGE)"
	@echo "  - ML Base: $(ML_BASE_IMAGE)"
	@echo "  - ML OCR: $(ML_OCR_IMAGE)"
