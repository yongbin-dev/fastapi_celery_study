
# Makefile for Monorepo

# ==============================================================================
# ë³€ìˆ˜ ì •ì˜
# ==============================================================================

# Python ì¸í„°í”„ë¦¬í„°
PYTHON = python3

# íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬
API_SERVER_DIR = packages/api_server
CELERY_WORKER_DIR = packages/celery_worker
ML_SERVER_DIR = packages/ml_server

# ==============================================================================
# docker base image build
# ==============================================================================
docker-base-build:
	@echo "ğŸ“¦ Docker Base Image..."
	@docker build -f $(ML_SERVER_DIR)/Dockerfile.base -t ml-server-base .


# ==============================================================================
# docker image build
# ==============================================================================
docker-build:
	@echo "ğŸ“¦ Docker Compose Build..."
	@docker compose build

# ==============================================================================
# docker base image build
# ==============================================================================
docker-start:
	@echo "ğŸ“¦ Docker Compose Start..."
	@docker compose up -d


# ==============================================================================
# ì˜ì¡´ì„± ê´€ë¦¬
# ==============================================================================

.PHONY: install
install:
	@echo "ğŸ“¦ ëª¨ë“  íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
	@./scripts/setup_all_packages.sh

# ==============================================================================
# ì½”ë“œ í’ˆì§ˆ
# ==============================================================================

.PHONY: lint
lint:
	@echo "ë¦°íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	@uv run ruff check .

.PHONY: format
format:
	@echo "ì½”ë“œë¥¼ í¬ë§·íŒ…í•©ë‹ˆë‹¤..."
	@uv run ruff format .

.PHONY: typecheck
typecheck:
	@echo "íƒ€ì… ì²´í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	@uv run pyright

# ==============================================================================
# í…ŒìŠ¤íŠ¸
# ==============================================================================

.PHONY: test
test:
	@echo "í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	@uv run pytest

# ==============================================================================
# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
# ==============================================================================

.PHONY: run-api
run-api:
	@echo "ğŸš€ API ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	@cd $(API_SERVER_DIR) && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

.PHONY: run-worker
run-worker:
	@echo "Celery ì›Œì»¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	@cd $(CELERY_WORKER_DIR) && celery -A celery_app worker --loglevel=info

.PHONY: run-ml
run-ml:
	@echo "ğŸ§  ML ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
	@cd $(ML_SERVER_DIR) && uvicorn ml_app.main:app --host 0.0.0.0 --port 8001 --reload

# ==============================================================================
# ì •ë¦¬
# ==============================================================================

.PHONY: clean
clean:
	@echo "ìºì‹œ íŒŒì¼ì„ ì •ë¦¬í•©ë‹ˆë‹¤..."
	@find . -type f -name "*.py[co]" -delete
	@find . -type d -name "__pycache__" -delete

.PHONY: clear-data clean-data
clear-data clean-data:
	@echo "ğŸ—‘ï¸  ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤ (Storage + Database)..."
	@uv run python scripts/clear_all.py

# ==============================================================================
# ë„ì›€ë§
# ==============================================================================

.PHONY: help
help:
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo "  install      - ëª¨ë“  íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤."
	@echo "  lint         - ë¦°íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
	@echo "  format       - ì½”ë“œë¥¼ í¬ë§·íŒ…í•©ë‹ˆë‹¤."
	@echo "  typecheck    - íƒ€ì… ì²´í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
	@echo "  test         - í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
	@echo "  run-api      - API ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
	@echo "  run-worker   - Celery ì›Œì»¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
	@echo "  run-ml       - ML ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
	@echo "  clean        - ìºì‹œ íŒŒì¼ì„ ì •ë¦¬í•©ë‹ˆë‹¤."
	@echo "  clear-data   - ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤ (Storage + Database)."
	@echo "  clean-data   - clear-dataì™€ ë™ì¼í•©ë‹ˆë‹¤."

